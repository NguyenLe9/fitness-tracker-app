<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fitness Progress Tracker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Fitness Progress Tracker</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section class="card">
      <h2>Calorie Goal</h2>
      <form method="post" action="{{ url_for('set_goal') }}" class="form-inline">
        <label for="calorie_goal">Daily calorie goal:</label>
        <input
          type="number"
          name="calorie_goal"
          id="calorie_goal"
          min="0"
          step="10"
          value="{{ calorie_goal or '' }}"
          required
        >
        <button type="submit">Save goal</button>
      </form>
      {% if calorie_goal %}
        <p class="note">Current goal: <strong>{{ calorie_goal }}</strong> kcal/day</p>
      {% endif %}
    </section>

    <section class="card">
      <h2>Add Daily Entry</h2>
      <form method="post" action="{{ url_for('add_entry') }}" class="form-grid">
        <div>
          <label for="date">Date</label>
          <input type="date" name="date" id="date" required>
        </div>
        <div>
          <label for="weight">Weight</label>
          <input type="number" name="weight" id="weight" step="0.1" placeholder="kg">
        </div>
        <div>
          <label for="calories">Calories</label>
          <input type="number" name="calories" id="calories" step="10" placeholder="kcal">
        </div>
        <div>
          <label for="steps">Steps</label>
          <input type="number" name="steps" id="steps" step="100" placeholder="steps">
        </div>
        <button type="submit" class="full-width">Add entry</button>
      </form>
    </section>

    <section class="card">
      <h2>Recent Entries</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Weight</th>
              <th>Calories</th>
              <th>Steps</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for e in entries %}
              {% set date_key = e.entry_date.strftime("%Y-%m-%d") %}
              {% set is_over = over_goal_flags.get(date_key, False) %}
              <tr class="{% if calorie_goal and is_over %}over-goal{% endif %}">
                <td>{{ e.entry_date }}</td>
                <td>{{ e.weight or "" }}</td>
                <td>{{ e.calories or "" }}</td>
                <td>{{ e.steps or "" }}</td>
                <td>
                  {% if calorie_goal and is_over %}
                    Over goal
                  {% else %}
                    &nbsp;
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Progress (Last 30 entries)</h2>
      <canvas id="fitnessChart" height="120"></canvas>
    </section>
  </div>

  <script>
    const labels = {{ chart_labels | tojson }};
    const weights = {{ chart_weights | tojson }};
    const calories = {{ chart_calories | tojson }};
    const steps = {{ chart_steps | tojson }};

    const ctx = document.getElementById('fitnessChart').getContext('2d');

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Weight',
            data: weights,
            yAxisID: 'y1',
            borderWidth: 2,
            pointRadius: 3,
          },
          {
            label: 'Calories',
            data: calories,
            yAxisID: 'y2',
            borderWidth: 1,
            borderDash: [5, 5],
            pointRadius: 0,
          },
          {
            label: 'Steps',
            data: steps,
            yAxisID: 'y2',
            borderWidth: 1,
            borderDash: [2, 4],
            pointRadius: 0,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          y1: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Weight' }
          },
          y2: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'Calories / Steps' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  </script>
</body>
</html>
